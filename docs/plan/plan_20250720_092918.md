# 実装計画：柔軟なエラーメッセージ除外システム

実装日時: 2025-07-20 09:29:18  
計画者: Claude Code  
ブランチ: feature/remove-timeout-urls  
関連調査: docs/investigate/investigate_20250720_091628.md

## 実装概要

WebText抽出システムにおいて、タイムアウトエラーや各種ブラウザエラーメッセージを柔軟に検出・除外する包括的なシステムを実装する。ユーザー要求に基づき、特定サイトに限定せず汎用的なエラーパターン管理機能を提供し、URLリストとテキストファイル両方の自動クリーンアップを実現する。

## ユーザー要求分析

1. **汎用的なエラー処理**: 知恵袋だけでなく、調査結果に記載されたエラーメッセージを表示するサイトを統一的に処理
2. **包括的なクリーンアップ**: URLリストの更新だけでなく、抽出されたエラーメッセージを含むテキストファイルも除外

## 実装方針

### コア戦略
- **設定ベースのエラーパターン管理**: config.iniでエラーパターンを定義・管理
- **既存ワークフローとの統合**: common_scriptsを活用した全ワークスペースでの統一処理
- **段階的実装**: 安全性を重視した段階的デプロイ
- **バックアップ機能**: 操作の可逆性を保証

## 詳細実装計画

### フェーズ1：基盤機能実装（高優先度）

#### 1.1 設定システム拡張
**対象ファイル**: `WebText_extraction*/config.ini`
```ini
[ERROR_PATTERNS]
enabled = true
browser_errors = このサイトにアクセスできません,ERR_TIMED_OUT,からの応答時間が長すぎます,接続を確認する,プロキシとファイアウォールを確認する
custom_patterns = 
backup_enabled = true
```

**実装内容**:
- ERROR_PATTERNSセクション追加
- デフォルトエラーパターン定義
- 機能有効/無効切り替えオプション
- カスタムパターン追加機能

#### 1.2 エラー検出機能強化
**対象ファイル**: `common_scripts/web_text_extractor_ver1.5.py`

**修正箇所**: `save_results`メソッド
- ブラウザエラーメッセージの検出
- config.iniからのエラーパターン読み込み
- エラーURL記録機能
- URLリストからの自動除外

**新機能**:
```python
def detect_browser_errors(self, text, url):
    """ブラウザエラーメッセージを検出"""
    
def remove_url_from_list(self, url, url_file):
    """URLリストから指定URLを除外"""
    
def backup_url_file(self, url_file):
    """URLファイルのバックアップ作成"""
```

#### 1.3 既存エラーファイルクリーンアップ
**新規ファイル**: `common_scripts/cleanup_error_pages.py`

**主要機能**:
- outputsフォルダのテキストファイルスキャン
- Integrated_Textフォルダのファイルスキャン  
- エラーパターンマッチング
- 該当ファイルの自動削除
- 削除操作ログ記録

```python
class ErrorPageCleanup:
    def scan_output_files(self, workspace_path):
        """outputsフォルダをスキャンしてエラーファイルを検出"""
        
    def scan_integrated_files(self, workspace_path):
        """Integrated_Textフォルダをスキャン"""
        
    def remove_error_files(self, file_list):
        """エラーファイルを削除"""
```

### フェーズ2：統合機能実装（中優先度）

#### 2.1 エラーパターン管理機能
**新規ファイル**: `common_scripts/error_pattern_manager.py`

**機能**:
- エラーパターンの動的追加・削除
- パターンの有効性検証
- 全ワークスペースへの設定同期

#### 2.2 統合処理強化
**対象ファイル**: `common_scripts/integrated.py`

**拡張内容**:
- 新しいエラーパターンへの対応
- cleanup_error_pages.pyとの連携
- 統合レポート機能

#### 2.3 ログ機能強化
**実装内容**:
- 除外URL・ファイルの詳細ログ
- 操作履歴管理
- エラー統計情報

### フェーズ3：運用機能実装（低優先度）

#### 3.1 レポート機能
- 除外操作サマリー
- パフォーマンス統計
- エラートレンド分析

#### 3.2 復旧機能
- バックアップからの復元
- 手動URL復旧
- 除外操作の取り消し

## ファイル変更計画

### 新規作成
```
common_scripts/
├── cleanup_error_pages.py          # 既存エラーファイル削除
├── error_pattern_manager.py        # エラーパターン管理
└── url_backup_manager.py           # URLバックアップ管理

docs/
└── plan/
    └── plan_20250720_092918.md     # 本文書
```

### 修正対象
```
common_scripts/
├── web_text_extractor_ver1.5.py    # save_resultsメソッド強化
└── integrated.py                   # エラーパターン統合処理

WebText_extraction*/
└── config.ini                      # ERROR_PATTERNSセクション追加
```

### 影響範囲
- 全WebText_extractionワークスペース（1-10）
- common_scriptsフォルダ（共有スクリプト）
- 既存outputsファイル（クリーンアップ対象）

## テスト戦略

### 単体テスト
1. **エラーパターン検出テスト**
   - 各エラーメッセージパターンの検出精度
   - 偽陽性・偽陰性のテストケース
   - config.ini読み込み機能

2. **ファイル操作テスト**
   - URLリスト更新機能
   - テキストファイル削除機能
   - バックアップ・復元機能

### 統合テスト
1. **ワークフロー全体テスト**
   - URL抽出 → テキスト抽出 → エラー検出 → クリーンアップ
   - 複数ワークスペース間の連携
   - common_scriptsの統一処理

2. **パフォーマンステスト**
   - 処理時間への影響測定
   - メモリ使用量監視
   - 並列処理効率

### E2Eテスト
1. **模擬環境テスト**
   - テスト用エラーメッセージファイル
   - 仮想URLリスト
   - Docker環境での実行

2. **リグレッションテスト**
   - 既存機能の動作確認
   - 後方互換性検証

## リスク分析と対策

### 高リスク
1. **有効URLの誤削除**
   - **対策**: 段階的バックアップ、手動確認オプション、リトライ機能
   - **実装**: url_backup_manager.pyによる自動バックアップ

2. **既存ワークフローへの影響**
   - **対策**: 設定による機能有効/無効切り替え、段階的デプロイ
   - **実装**: config.iniのenabled フラグ

### 中リスク
3. **パフォーマンス影響**
   - **対策**: 効率的なパターンマッチング、並列処理最適化
   - **実装**: 正規表現の最適化、キャッシュ機能

4. **設定管理複雑化**
   - **対策**: common_scriptsでの統一管理、自動同期機能
   - **実装**: error_pattern_manager.pyによる統一管理

### 低リスク
5. **ログ容量増加**
   - **対策**: ログローテーション、古いログ自動削除
   - **実装**: 設定可能な保持期間

## 実装スケジュール

### Week 1: フェーズ1実装
- Day 1-2: config.ini拡張とエラーパターン定義
- Day 3-4: web_text_extractor_ver1.5.py強化
- Day 5: cleanup_error_pages.py実装
- Day 6-7: 単体テスト実施

### Week 2: フェーズ2実装  
- Day 1-2: error_pattern_manager.py実装
- Day 3-4: integrated.py拡張とログ機能
- Day 5-7: 統合テスト実施

### Week 3: テスト・デプロイ
- Day 1-3: E2Eテスト実施
- Day 4-5: リグレッションテスト
- Day 6-7: 段階的デプロイと監視

## 成功基準

### 機能的基準
1. ✅ 調査で特定されたエラーメッセージの100%検出
2. ✅ URLリストからのエラーURL自動除外
3. ✅ 既存エラーファイルの自動削除
4. ✅ 全ワークスペースでの統一処理

### 運用的基準  
1. ✅ 既存処理への影響なし（性能劣化5%以内）
2. ✅ バックアップ機能による操作可逆性
3. ✅ 設定による機能制御
4. ✅ 包括的なログ記録

### ユーザビリティ基準
1. ✅ 直感的な設定ファイル構造
2. ✅ 明確なログメッセージ
3. ✅ 簡単な復旧手順

## 注意事項

### 開発時
- 全ワークスペースの設定同期が必要
- common_scriptsの変更は全環境に影響
- 既存データのバックアップ必須

### 運用時
- 定期的なエラーパターン見直し
- バックアップファイルの容量監視
- ログファイルの定期クリーンアップ

### 保守時
- 新しいエラーパターンの迅速な追加
- パフォーマンス監視とチューニング
- ユーザーフィードバックに基づく改善

## 結論

本実装計画は、ユーザー要求である「汎用的なエラーメッセージ処理」と「包括的なクリーンアップ機能」を満たす包括的なソリューションを提供する。段階的実装によりリスクを最小化し、バックアップ機能により安全性を確保する。

実装完了により、WebText抽出システムの品質向上と運用効率化を実現し、エラーメッセージの混入を根本的に解決する。